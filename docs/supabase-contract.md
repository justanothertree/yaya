# Supabase Contract (public schema)

This document is the authoritative contract for the game backend in Supabase.
If code changes require schema changes, update this file AND `db-schema-summary.sql`.

## Environment variables

Frontend (Vite):
- VITE_SUPABASE_URL
- VITE_SUPABASE_ANON_KEY
- VITE_LEADERBOARD_TABLE=leaderboard (recommended)
- VITE_SCORE_HISTORY_TABLE=score_history (recommended)
- VITE_PLAYER_TABLE=player_registry (recommended)
- VITE_TROPHIES_TABLE=trophies (recommended)
- VITE_LEADERBOARD_NAME_COLUMN=player_name
- VITE_WS_URL=ws://localhost:8080 (local)

## Tables

### player_registry
Purpose: stable registry of player identities (currently name-based; no auth yet)

Columns:
- id (bigint, PK)
- player_name (citext, UNIQUE)
- created_at (timestamptz, default now())

Relationships:
- referenced by leaderboard.player_id
- referenced by score_history.player_id

### leaderboard
Purpose: best score per player per mode

Columns:
- id (bigint, PK)
- player_id (bigint, FK -> player_registry.id)
- player_name (text)
- score (int, check score >= 0 if present)
- game_mode (text, default currently 'solo' in DB)
- apples_eaten (int, default 0)
- time_elapsed (int, default 0)
- created_at (timestamptz, default now())

Constraints / indexes:
- UNIQUE (player_id, game_mode)  (required for upsert-best-score logic)

### score_history
Purpose: append-only history of all submitted scores

Columns:
- id (bigint, PK)
- player_id (bigint, FK -> player_registry.id)
- player_name (text)
- score (int, check score >= 0 if present)
- game_mode (text, default currently 'solo' in DB)
- apples_eaten (int, default 0)
- time_elapsed (int, default 0)
- created_at (timestamptz, default now())

### trophies
Purpose: trophies awarded for leaderboard placement (gold/silver/bronze etc.)

Columns:
- id (bigint, PK)
- leaderboard_id (bigint, FK -> leaderboard.id)
- trophy_name (text)
- awarded_at (timestamptz, default now())

### round_results
Purpose: authoritative multiplayer round results (idempotent per room_id + round_id)

Columns:
- id (bigint, PK)
- room_id (text)
- round_id (text)
- game_mode (text, default 'survival' in DB)
- results (jsonb)
- created_at (timestamptz, default now())

Constraints:
- UNIQUE (room_id, round_id)

## RPCs / Functions

### finalize_round_rpc(p_room_id text, p_round_id text, p_game_mode text, p_items jsonb, p_players jsonb) -> jsonb
Purpose:
- Idempotently finalize a multiplayer round using (room_id, round_id)
- Persist results to round_results
- Insert rows into score_history
- Upsert best score into leaderboard (per player_id + game_mode)
- Optionally award trophies (if implemented in function body)

Inputs:
- p_room_id: room identifier (should match ws-server roomId)
- p_round_id: round identifier generated by ws-server.js (must match exactly)
- p_game_mode: e.g. 'survival'
- p_items: JSON array of player results; each item must include:
  - id (client id)
  - name (player name)
  - score (integer)
  - finishIdx (integer)
- p_players: JSON array (optional); if present used for name mapping / metadata

Return:
- jsonb (current implementation returns an ordered JSON array of result objects)
  Example:
  [
    { "id": "p1", "name": "Alice", "score": 10, "place": 1 },
    { "id": "p2", "name": "Bob", "score": 8, "place": 2 }
  ]

Important invariants:
- Must be safe to call multiple times for same (room_id, round_id) (idempotent)
- Results ordering must be deterministic (place asc; tie-breakers consistent)

### enforce_best_score() -> trigger
Purpose:
- Trigger function used to prevent decreasing leaderboard score on UPDATE (if attached)

### enforce_best_score(p_player_id integer, p_game_mode text) -> void
Purpose:
- Utility RPC (optional) to enforce best-score invariants for a specific player/mode
Return:
- void (null)

## Security / RLS notes (current)
- No auth yet; public anon key used.
- RLS status must match what the client is doing.
- If direct table writes are removed in favor of RPC-only writes, tighten RLS accordingly.

## Client expectations (must stay true)
- multiplayer: round_id must come from ws-server.js and match what is written into round_results
- spectators: must never write to Supabase (no score_history/leaderboard/trophies inserts)
- do not rename tables/columns/functions without updating this contract AND the code references
